# テーマB 潮流計算可視化シミュレータの製作

これは python を用いた潮流計算可視化シミュレータである。

------------------------------------

## ファイル

- visualize.py (メイン-by宇埜 一平)
- getdata.py (2020process.csv からデータを取得する-by渡邉 健人)
- draw_graph.py (電圧の時間変化をプロットする-by野々村 祐人)
- 2020process.csv (沖縄電力の需給データ)

## 依存関係

- visualize.py
    - sys
    - numpy
    - pygame
    - loadflow
    - getdata
        - numpy
    - draw_graph
        - matplotlib
        - pygame-matplotlib

-------------------------------------

## 目次

0. pygame の概要
1. loadflow の動作
2. visualize.py の動作
3. getdata.py の動作
4. draw_graph.py の動作

-------------------------------------

## 0. pygame の概要

pygame は python を用いたゲーム制作用のモジュールである。ゲームオブジェクトである`Surface`オブジェクトとその位置を表す`Rect`オブジェクトを用いて、毎フレームごとに画面を描画する。

### 骨格

    pygame の初期化
    スクリーンの初期化

    Surface オブジェクトを用意
    Rect オブジェクトを設定

    while True:

        イベントを取得、処理
        Surface の描画
        更新

## 1. loadflow の動作

loadflow は潮流計算を効率的に行うために自作したモジュールである。

## 2. visualize.py の動作

visualize.py は pygame を用いた潮流計算の可視化シミュレータのメインのプログラムである。この項では実装上の細かい点には触れずにプログラムの全体像を俯瞰する。詳細は実際のコードを参照されたい。十分なコメントを載せてある。

プログラムの制御には基本的にはフラグを使っている。「0. pygame の概要」に書いたような骨格になっており、発生するイベントによりフラグを更新し、その下の描画部分ではフラグを元に何を描画するかを決めている。

### コントロール機能

- 日付の設定
- 時間の設定
- ２つのノード間の電力需要の割合を設定
- 時間変化のコントロール
    - 再生と停止
    - ループ
    - 1日分の再生時間の設定
- 電圧のグラフの表示

#### 日付の設定

本プログラムでは2020年度の沖縄電力の電力需給データから8日を選んで使用している。その8つには0から7までのidが振ってあり、プログラム中では一貫してそれらのidで日付を指定、参照している。現在の日付は左上に表示される。そこをクリックするとカレンダーが表示され、クリックした日付が選択される。左上のボタン、カレンダー内の各日付はそれぞれ pygame の Surface オブジェクトになっており、それぞれとマウスの当たり判定により、イベントが発生する。

#### 時間の設定

本プログラムにおける時間の変数 time はプログラム内で、あらゆる動作の基準になるパラメータである。例えば、時間を表すバーをクリックすることによって時間を変更できるが、クリック位置から直接指針の位置を決めるのではなく、クリック位置から時間を決定し、時間から指針の位置を決定する。これは矛盾が起きないようにするためである。プログラム内で、分の単位まで時刻が表示されるようになっているが、使用しているデータは１時間ごとのものである。これは時刻をさまざまなパラメータとして用いているために、１時間ごとの時間変化では視覚的に満足の行く効果が得られないからである。例えば、電力の流れを表す矢印の脈動は時刻の分の成分を使っている。また、空の色も時刻から算出している。しかし、毎フレーム潮流計算をするのは計算資源の無駄だから、時刻の時間成分が変化したときにのみ潮流計算されるようになっている。

#### ２つのノード間の電力需要の割合を設定

沖縄電力のデータからは総需要しか得られないが、それを2つのノードに割り振る時の割合によって計算結果がどう変化するのかを知ることができるようにした。中央上部のスライドを変化させることで、設定することができる。各ノードが消費している電力をゲージに示してわかりやすくした。

#### 時間変化のコントロール

中央下部のコントロールパネルで時間変化の設定ができる。

##### 再生と停止

時間の更新を開始、停止することができる。

##### ループ

時間が24時以上になると、０時に戻るが、右側のボタンでそれと同時に再生するか、停止するかを選択できる。

##### 1日分の再生時間(周期)の設定

左側のスライドで1日分のシミュレーションを何秒で再生するかを選択することができる。つまり、時間の変数の更新は、`time += 1/period` となる。ただし、`period` は1日分の周期である。

#### 電圧のグラフの表示

`while` ループの中で１日の間に24回の潮流計算が行われるのであるが、その24回分の各ノードの電圧が計算のたびに配列に保存される(4x24の２次元配列)。そして、23時になると、データがプロットされ、Surface として配列に保存される。ただし、最新の4つのプロット以外は消去される。また、データを保存する際に手動での時間変化または日付の変化を行った場合はグラフはプロットされない。一度プロットした後に日付や需要の割合を触らずに二度目の実行をしてもプロットされない。つまり、過去4回の異なる条件でのシミュレーションにおける各ノードの電圧の時間変化を表示するというわけである。

### while 文の内容

プログラムのメインの部分である `while` 文の内容についての流れを見ていく。

    while True

        イベントループ

        背景描画
        ノード間のブランチとして線を描画

        日付、時刻から該当データを取得し、潮流計算をする
        計算を元に電圧の指針を設定
        計算を元にブランチの有効電力を示す棒を設定

        ブランチの有効電力を示す棒を描画
        各ノードを描画
        電圧の指針を描画

        グラフ表示ボタンを描画
        時刻を示すバーを描画
        時刻の数値を描画

        負荷ノードの有効電力を示すゲージを設定、描画

        日付の表示を描画
        if カレンダーが表示されている:
            カレンダーを描画

        コントロールパネルを描画
        再生または停止ボタンを描画
        周期設定用のスライド描画
        ループがアクティブかに応じて描画

        電力需要の割合変化スライドの描画

        if グラフが表示:
            グラフ背景描画
            グラフ描画

        if 再生中:
            時刻　+= 1/周期

            if 時刻 >= 24:
                時刻 = 0
                if ループが非アクティブ:
                    再生を停止

        if このフレームで時刻の時間成分または日付が変更された:
            計算済み = False

        フレームを更新

イベントループの内容は以下である。

    for イベント:
        if マウスが押された:
            if グラフが非表示:

                if 日付表示が押された:
                    カレンダーの表示/非表示を切り替える

                if カレンダーが表示されている:
                    if 日付が押された:
                        日付 = 押された日付
                        時刻 = 0
                        電力需要の割合 = デフォルト値
                        周期 = デフォルト値
                        グラフ描画済み = False

                if グラフ表示ボタンが押された:
                    グラフを表示する
                    再生を停止する

                if 時刻バーが押された:
                    時刻の値を更新する
                    時刻をドラッグ開始する
                    グラフデータの取得を取り消しする

                if 停止中:
                    if 再生ボタンが押された:
                        再生を開始する
                        if 計算失敗:
                            時刻 = 0 にしてやり直す
                elif 停止ボタンが押された:
                    再生を停止する
                    時刻の分をその時間の30分に設定する
                if ループボタンが押された:
                    ループのアクティブ/非アクティブを切り替える

                if 電力需要の割合変化スライドが押された:
                    割合変化を開始する
                    グラフ描画済み = False

                if 周期の変化スライドが押された:
                    周期変化を開始する

            else:  # グラフが表示されている
                グラフを非表示にする

        if マウスが動いた:

            if 時刻のドラッグが開始されている:
                時刻の値を更新する

            if 需要の割合変化が開始されている:
                割合の値を更新する

            if 周期変化が開始されている:
                周期の値を更新する

        if マウスが放された:

            時刻の値の更新を停止する
            割合の値の更新を停止する
            周期の値の更新を停止する
